<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.buyauto.mapper.orders.TOrdersCommissionMapper">
	<resultMap id="BaseResultMap" type="com.buyauto.entity.orders.TOrdersCommission">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		<id column="id" property="id" jdbcType="BIGINT" />
		<result column="order_id" property="orderId" jdbcType="BIGINT" />
		<result column="user_id" property="userId" jdbcType="BIGINT" />
		<result column="beneficiary_id" property="beneficiaryId"
			jdbcType="BIGINT" />
		<result column="father_id" property="fatherId" jdbcType="BIGINT" />
		<result column="father_phone" property="fatherPhone" jdbcType="VARCHAR" />
		<result column="register_date" property="registerDate"
			jdbcType="TIMESTAMP" />
		<result column="count" property="count" jdbcType="INTEGER" />
		<result column="amount" property="amount" jdbcType="DECIMAL" />
		<result column="commission" property="commission" jdbcType="DECIMAL" />
		<result column="complete_time" property="completeTime"
			jdbcType="TIMESTAMP" />
		<result column="create_date" property="createDate" jdbcType="TIMESTAMP" />
	</resultMap>

	<resultMap id="RecommenderListMap" type="com.buyauto.dao.orders.TUsersCommissionDao">
		<id column="id" property="id" jdbcType="BIGINT" />
		<result column="phone" property="phone" jdbcType="VARCHAR" />
		<result column="create_date" property="createDate" jdbcType="TIMESTAMP" />
		<result column="ratio" property="ratio" jdbcType="VARCHAR" />
		<result column="commission" property="commission" jdbcType="DECIMAL" />
	</resultMap>
	<sql id="Base_Column_List">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		id, order_id, user_id, beneficiary_id, father_id, father_phone,
		register_date, count,
		amount, commission, complete_time, create_date,ratio
	</sql>
	<select id="selectByPrimaryKey" resultMap="BaseResultMap"
		parameterType="java.lang.Long">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		select
		<include refid="Base_Column_List" />
		from t_orders_commission
		where id = #{id,jdbcType=BIGINT}
	</select>
	<delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		delete from t_orders_commission
		where id = #{id,jdbcType=BIGINT}
	</delete>
	<insert id="insert" parameterType="com.buyauto.entity.orders.TOrdersCommission">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		insert into t_orders_commission (id, order_id, user_id,
		beneficiary_id, father_id, father_phone,
		register_date, count, amount,
		commission, complete_time, create_date,ratio
		)
		values (#{id,jdbcType=BIGINT},
		#{orderId,jdbcType=BIGINT},
		#{userId,jdbcType=BIGINT},
		#{beneficiaryId,jdbcType=BIGINT}, #{fatherId,jdbcType=BIGINT},
		#{fatherPhone,jdbcType=VARCHAR},
		#{registerDate,jdbcType=TIMESTAMP},
		#{count,jdbcType=INTEGER},
		#{amount,jdbcType=DECIMAL},
		#{commission,jdbcType=DECIMAL}, #{completeTime,jdbcType=TIMESTAMP},
		#{createDate,jdbcType=TIMESTAMP},
		#{ratio,jdbcType=VARCHAR}
		)
	</insert>
	<insert id="insertSelective" parameterType="com.buyauto.entity.orders.TOrdersCommission">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		insert into t_orders_commission
		<trim prefix="(" suffix=")" suffixOverrides=",">
			<if test="id != null">
				id,
			</if>
			<if test="orderId != null">
				order_id,
			</if>
			<if test="userId != null">
				user_id,
			</if>
			<if test="beneficiaryId != null">
				beneficiary_id,
			</if>
			<if test="fatherId != null">
				father_id,
			</if>
			<if test="fatherPhone != null">
				father_phone,
			</if>
			<if test="registerDate != null">
				register_date,
			</if>
			<if test="count != null">
				count,
			</if>
			<if test="amount != null">
				amount,
			</if>
			<if test="commission != null">
				commission,
			</if>
			<if test="completeTime != null">
				complete_time,
			</if>
			<if test="createDate != null">
				create_date,
			</if>
			<if test="ratio != null">
				ratio,
			</if>
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides=",">
			<if test="id != null">
				#{id,jdbcType=BIGINT},
			</if>
			<if test="orderId != null">
				#{orderId,jdbcType=BIGINT},
			</if>
			<if test="userId != null">
				#{userId,jdbcType=BIGINT},
			</if>
			<if test="beneficiaryId != null">
				#{beneficiaryId,jdbcType=BIGINT},
			</if>
			<if test="fatherId != null">
				#{fatherId,jdbcType=BIGINT},
			</if>
			<if test="fatherPhone != null">
				#{fatherPhone,jdbcType=VARCHAR},
			</if>
			<if test="registerDate != null">
				#{registerDate,jdbcType=TIMESTAMP},
			</if>
			<if test="count != null">
				#{count,jdbcType=INTEGER},
			</if>
			<if test="amount != null">
				#{amount,jdbcType=DECIMAL},
			</if>
			<if test="commission != null">
				#{commission,jdbcType=DECIMAL},
			</if>
			<if test="completeTime != null">
				#{completeTime,jdbcType=TIMESTAMP},
			</if>
			<if test="createDate != null">
				#{createDate,jdbcType=TIMESTAMP},
			</if>
			<if test="ratio != null">
				#{ratio,jdbcType=VARCHAR},
			</if>
			
		</trim>
	</insert>
	<update id="updateByPrimaryKeySelective" parameterType="com.buyauto.entity.orders.TOrdersCommission">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		update t_orders_commission
		<set>
			<if test="orderId != null">
				order_id = #{orderId,jdbcType=BIGINT},
			</if>
			<if test="userId != null">
				user_id = #{userId,jdbcType=BIGINT},
			</if>
			<if test="beneficiaryId != null">
				beneficiary_id = #{beneficiaryId,jdbcType=BIGINT},
			</if>
			<if test="fatherId != null">
				father_id = #{fatherId,jdbcType=BIGINT},
			</if>
			<if test="fatherPhone != null">
				father_phone = #{fatherPhone,jdbcType=VARCHAR},
			</if>
			<if test="registerDate != null">
				register_date = #{registerDate,jdbcType=TIMESTAMP},
			</if>
			<if test="count != null">
				count = #{count,jdbcType=INTEGER},
			</if>
			<if test="amount != null">
				amount = #{amount,jdbcType=DECIMAL},
			</if>
			<if test="commission != null">
				commission = #{commission,jdbcType=DECIMAL},
			</if>
			<if test="completeTime != null">
				complete_time = #{completeTime,jdbcType=TIMESTAMP},
			</if>
			<if test="createDate != null">
				create_date = #{createDate,jdbcType=TIMESTAMP},
			</if>
			<if test="createDate != null">
				ratio = #{ratio,jdbcType=VARCHAR},
			</if>
		</set>
		where id = #{id,jdbcType=BIGINT}
	</update>
	<update id="updateByPrimaryKey" parameterType="com.buyauto.entity.orders.TOrdersCommission">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		update t_orders_commission
		set order_id = #{orderId,jdbcType=BIGINT},
		user_id = #{userId,jdbcType=BIGINT},
		beneficiary_id =
		#{beneficiaryId,jdbcType=BIGINT},
		father_id =
		#{fatherId,jdbcType=BIGINT},
		father_phone =
		#{fatherPhone,jdbcType=VARCHAR},
		register_date =
		#{registerDate,jdbcType=TIMESTAMP},
		count = #{count,jdbcType=INTEGER},
		amount = #{amount,jdbcType=DECIMAL},
		commission =
		#{commission,jdbcType=DECIMAL},
		complete_time =
		#{completeTime,jdbcType=TIMESTAMP},
		ratio = #{ratio,jdbcType=VARCHAR},
		create_date =
		#{createDate,jdbcType=TIMESTAMP}
		where id = #{id,jdbcType=BIGINT}
	</update>

	<select id="queryCommissionConfig" resultMap="BaseResultMap">
		select
		<include refid="Base_Column_List" />
		from t_orders_commission
	</select>

	<select id="getUsersCommissionList" resultMap="RecommenderListMap">
		SELECT
		toc.id,
		tu.phone,
		toc.ratio,
		toc.commission,
		toc.create_date
		FROM
		t_orders_commission toc
		LEFT JOIN t_users tu
		ON toc.`user_id` = tu.`id`
		WHERE toc.`beneficiary_id` = #{uId} ORDER BY toc.create_date
		DESC
		LIMIT
		#{pageStartNumber},#{pageEndNumber}
		<!-- SELECT tu.id, tu.`phone`, tu.`create_date`, (SELECT SUM(toc.count) 
			FROM t_orders_commission toc WHERE toc.user_id=tu.`id` AND toc.`beneficiary_id`=#{uId}) 
			AS COUNT, (SELECT SUM(tou.commission) FROM t_orders_commission tou WHERE 
			tou.user_id=tu.`id` AND tou.`beneficiary_id`=#{uId}) AS commission FROM t_users_recommender 
			tur LEFT JOIN t_users tu ON tur.`user_id`=tu.`id` LEFT JOIN t_orders_commission 
			toc ON tu.id = toc.user_id WHERE tur.`user_id` = #{uId} OR tur.father_id=#{uId} 
			OR tur.grandpa_id=#{uId} GROUP BY tu.`id` ORDER BY tu.create_date DESC LIMIT 
			#{pageStartNumber},#{pageEndNumber} -->
	</select>

	<select id="getUsersCommissionByCount" resultType="java.lang.Integer">
		SELECT
		COUNT(*)
		FROM
		t_orders_commission toc
		LEFT JOIN t_users tu
		ON
		toc.`user_id` = tu.`id`
		WHERE toc.`beneficiary_id` = #{uId}
		<!--SELECT COUNT(*) FROM ( SELECT tu.id, tu.`phone`, tu.`create_date`, 
			SUM(toc.count) AS COUNT, (SELECT SUM(tou.commission) FROM t_orders_commission 
			tou WHERE tou.user_id=tu.`id` AND tou.`beneficiary_id`=#{uId}) AS commission 
			FROM t_users_recommender tur LEFT JOIN t_users tu ON tur.`user_id`=tu.`id` 
			LEFT JOIN t_orders_commission toc ON tu.id = toc.user_id WHERE tur.`user_id` 
			= #{uId} OR tur.father_id=#{uId} OR tur.grandpa_id=#{uId} GROUP BY tu.`id` 
			) t -->
	</select>
</mapper>