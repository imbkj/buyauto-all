<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.buyauto.mapper.user.TUsersRecommenderMapper">
	<resultMap id="BaseResultMap" type="com.buyauto.entity.user.TUsersRecommender">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		<id column="id" property="id" jdbcType="BIGINT" />
		<result column="user_id" property="userId" jdbcType="BIGINT" />
		<result column="user_phone" property="userPhone" jdbcType="VARCHAR" />
		<result column="father_id" property="fatherId" jdbcType="BIGINT" />
		<result column="father_phone" property="fatherPhone" jdbcType="VARCHAR" />
		<result column="grandpa_id" property="grandpaId" jdbcType="BIGINT" />
		<result column="grandpa_phone" property="grandpaPhone"
			jdbcType="VARCHAR" />
		<result column="create_date" property="createDate" jdbcType="TIMESTAMP" />
	</resultMap>

	<resultMap id="RecommenderMap" type="com.buyauto.dao.user.TUsersRecommenderDao">
		<id column="id" property="id" jdbcType="BIGINT" />
		<result column="name" property="name" jdbcType="VARCHAR" />
		<result column="phone" property="phone" jdbcType="VARCHAR" />
		<result column="cardID" property="cardID" jdbcType="VARCHAR" />
		<result column="type" property="type" jdbcType="VARCHAR" />
		<result column="debit_card" property="debitCard" jdbcType="VARCHAR" />
		<result column="debit_card_bank" property="debitCardBank"
			jdbcType="VARCHAR" />
		<result column="credit_card" property="creditCard" jdbcType="VARCHAR" />
		<result column="credit_card_bank" property="creditCardBank"
			jdbcType="VARCHAR" />
		<result column="sumSellAmount" property="sumSellAmount"
			jdbcType="DECIMAL" />
		<result column="sumCommission" property="sumCommission"
			jdbcType="DECIMAL" />
	</resultMap>
	<sql id="Base_Column_List">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		id, user_id, user_phone, father_id, father_phone,
		create_date,grandpa_id,grandpa_phone
	</sql>
	<select id="selectByPrimaryKey" resultMap="BaseResultMap"
		parameterType="java.lang.Long">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		select
		<include refid="Base_Column_List" />
		from t_users_recommender
		where id = #{id,jdbcType=BIGINT}
	</select>
	<delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		delete from t_users_recommender
		where id = #{id,jdbcType=BIGINT}
	</delete>
	<insert id="insert" parameterType="com.buyauto.entity.user.TUsersRecommender">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		insert into t_users_recommender (id, user_id, user_phone,
		father_id,
		father_phone, create_date,grandpa_id,grandpa_phone
		)
		values
		(#{id,jdbcType=BIGINT}, #{userId,jdbcType=BIGINT},
		#{userPhone,jdbcType=VARCHAR},
		#{fatherId,jdbcType=BIGINT},
		#{fatherPhone,jdbcType=VARCHAR},
		#{createDate,jdbcType=TIMESTAMP},#{grandpaId,jdbcType=BIGINT},
		#{grandpaPhone,jdbcType=VARCHAR}
		)
	</insert>
	<insert id="insertSelective" parameterType="com.buyauto.entity.user.TUsersRecommender">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		insert into t_users_recommender
		<trim prefix="(" suffix=")" suffixOverrides=",">
			<if test="id != null">
				id,
			</if>
			<if test="userId != null">
				user_id,
			</if>
			<if test="userPhone != null">
				user_phone,
			</if>
			<if test="fatherId != null">
				father_id,
			</if>
			<if test="fatherPhone != null">
				father_phone,
			</if>
			<if test="createDate != null">
				create_date,
			</if>
			<if test="grandpaId != null">
				grandpa_id,
			</if>
			<if test="grandpaPhone != null">
				grandpa_phone,
			</if>
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides=",">
			<if test="id != null">
				#{id,jdbcType=BIGINT},
			</if>
			<if test="userId != null">
				#{userId,jdbcType=BIGINT},
			</if>
			<if test="userPhone != null">
				#{userPhone,jdbcType=VARCHAR},
			</if>
			<if test="fatherId != null">
				#{fatherId,jdbcType=BIGINT},
			</if>
			<if test="fatherPhone != null">
				#{fatherPhone,jdbcType=VARCHAR},
			</if>
			<if test="createDate != null">
				#{createDate,jdbcType=TIMESTAMP},
			</if>
			<if test="grandpaId != null">
				#{grandpaId,jdbcType=BIGINT},
			</if>
			<if test="grandpaPhone != null">
				#{grandpaPhone,jdbcType=VARCHAR},
			</if>
		</trim>
	</insert>
	<update id="updateByPrimaryKeySelective" parameterType="com.buyauto.entity.user.TUsersRecommender">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		update t_users_recommender
		<set>
			<if test="userId != null">
				user_id = #{userId,jdbcType=BIGINT},
			</if>
			<if test="userPhone != null">
				user_phone = #{userPhone,jdbcType=VARCHAR},
			</if>
			<if test="fatherId != null">
				father_id = #{fatherId,jdbcType=BIGINT},
			</if>
			<if test="fatherPhone != null">
				father_phone = #{fatherPhone,jdbcType=VARCHAR},
			</if>
			<if test="createDate != null">
				create_date = #{createDate,jdbcType=TIMESTAMP},
			</if>
			<if test="grandpaId != null">
				grandpa_id = #{grandpaId,jdbcType=BIGINT},
			</if>
			<if test="grandpaPhone != null">
				grandpa_phone = #{grandpaPhone,jdbcType=VARCHAR},
			</if>
		</set>
		where id = #{id,jdbcType=BIGINT}
	</update>
	<update id="updateByPrimaryKey" parameterType="com.buyauto.entity.user.TUsersRecommender">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. -->
		update t_users_recommender
		set user_id = #{userId,jdbcType=BIGINT},
		user_phone = #{userPhone,jdbcType=VARCHAR},
		father_id =
		#{fatherId,jdbcType=BIGINT},
		father_phone =
		#{fatherPhone,jdbcType=VARCHAR},
		create_date =
		#{createDate,jdbcType=TIMESTAMP},
		grandpa_id =
		#{grandpaId,jdbcType=BIGINT},
		grandpa_phone =
		#{grandpaPhone,jdbcType=VARCHAR}
		where id = #{id,jdbcType=BIGINT}
	</update>

	<select id="selectRecommenderByPhone" resultMap="BaseResultMap">
		SELECT tur.id,tu.id AS
		user_id,tur.user_phone,father_id,father_phone,grandpa_id,grandpa_phone,tu.create_date
		FROM t_users tu LEFT JOIN t_users_recommender tur ON tu.id=tur.user_id
		where 1=1
		<if test="phone != null">
			and tu.phone = #{phone}
		</if>
		<if test="name != null">
			and tu.name = #{name}
		</if>
	</select>

	<select id="selectRecommenderByUid" resultMap="RecommenderMap">
		select * from
		(
		SELECT
		tu.`id`,tus.`name`,tu.`phone`,tus.`cardID`,'0' as
		type,tus.`debit_card`,tus.`debit_card_bank`,tus.`credit_card`,tus.`credit_card_bank`,(SELECT
		SUM(tou.amount) FROM t_orders tou WHERE
		tou.`user_id`=tu.`id` and
		tou.status=200
		<if test="startTime != null">
			and tou.create_date &gt;=#{startTime}
		</if>
		<if test="endTime != null">
			and tou.create_date &lt;=#{endTime}
		</if>
		) AS sumSellAmount,SUM(toc.commission) as
		sumCommission,tu.create_date
		FROM t_users tu
		LEFT JOIN t_users_sales tus
		ON tu.id=tus.`user_id`
		LEFT
		JOIN t_orders_commission toc
		ON tu.id =
		toc.`beneficiary_id`
		LEFT JOIN
		t_users_recommender tur ON
		tu.id=tur.`user_id`
		WHERE tu.`id` =
		#{uId}
		<if test="startTime != null">
			and toc.create_date &gt;=#{startTime}
		</if>
		<if test="endTime != null">
			and toc.create_date &lt;=#{endTime}
		</if>
		GROUP BY tu.`id`
		<if test="fatherId != null and (type == 3 or type == 0)">
			UNION
			SELECT
			tu.`id`,tus.`name`,tu.`phone`,tus.`cardID`,'3' as
			type,tus.`debit_card`,tus.`debit_card_bank`,tus.`credit_card`,tus.`credit_card_bank`,(SELECT
			SUM(tou.amount) FROM t_orders tou WHERE
			tou.`user_id`=tu.`id` and
			tou.status=200
			<if test="startTime != null">
				and tou.create_date &gt;=#{startTime}
			</if>
			<if test="endTime != null">
				and tou.create_date &lt;=#{endTime}
			</if>
			) AS sumSellAmount,SUM(toc.commission) as
			sumCommission,tu.create_date
			FROM t_users tu
			LEFT JOIN t_users_sales
			tus ON tu.id=tus.`user_id`
			LEFT JOIN t_orders_commission toc
			ON tu.id =
			toc.`beneficiary_id`
			LEFT JOIN
			t_users_recommender tur ON
			tu.id=tur.`user_id`
			WHERE tu.`id` =
			#{fatherId}
			<if test="startTime != null">
				and toc.create_date &gt;=#{startTime}
			</if>
			<if test="endTime != null">
				and toc.create_date &lt;=#{endTime}
			</if>
			GROUP BY tu.`id`
		</if>
		<if test="grandpaId != null and (type == 4 or type == 0)">
			UNION
			SELECT
			tu.`id`,tus.`name`,tu.`phone`,tus.`cardID`,'4' as
			type,tus.`debit_card`,tus.`debit_card_bank`,tus.`credit_card`,tus.`credit_card_bank`,(SELECT
			SUM(tou.amount) FROM t_orders tou WHERE
			tou.`user_id`=tu.`id` and
			tou.status=200
			<if test="startTime != null">
				and tou.create_date &gt;=#{startTime}
			</if>
			<if test="endTime != null">
				and tou.create_date &lt;=#{endTime}
			</if>
			) AS sumSellAmount,SUM(toc.commission) as
			sumCommission,tu.create_date
			FROM t_users tu
			LEFT JOIN t_users_sales
			tus ON tu.id=tus.`user_id`
			LEFT JOIN t_orders_commission toc
			ON tu.id =
			toc.`beneficiary_id`
			LEFT JOIN
			t_users_recommender tur ON
			tu.id=tur.`user_id`
			WHERE tu.`id` =
			#{grandpaId}
			<if test="startTime != null">
				and toc.create_date &gt;=#{startTime}
			</if>
			<if test="endTime != null">
				and toc.create_date &lt;=#{endTime}
			</if>
			GROUP BY tu.`id`
		</if>
		<if test="type == 1 or type == 0">
			UNION
			SELECT
			tu.`id`,tus.`name`,tu.`phone`,tus.`cardID`,'1' as
			type,tus.`debit_card`,tus.`debit_card_bank`,tus.`credit_card`,tus.`credit_card_bank`,(SELECT
			SUM(tou.amount) FROM t_orders tou WHERE
			tou.`user_id`=tur.`user_id`
			and tou.status=200
			<if test="startTime != null">
				and tou.create_date &gt;=#{startTime}
			</if>
			<if test="endTime != null">
				and tou.create_date &lt;=#{endTime}
			</if>
			) AS sumSellAmount,SUM(toc.commission) as
			sumCommission,tu.create_date
			FROM t_users tu
			LEFT JOIN t_users_sales
			tus ON tu.id=tus.`user_id`
			LEFT JOIN t_orders_commission toc
			ON tu.id =
			toc.`beneficiary_id`
			LEFT JOIN
			t_users_recommender tur ON
			tu.id=tur.`user_id`
			WHERE
			tur.`father_id`=
			#{uId}
			<if test="startTime != null">
				and toc.create_date &gt;=#{startTime}
			</if>
			<if test="endTime != null">
				and toc.create_date &lt;=#{endTime}
			</if>
			GROUP BY tu.`id`
		</if>
		<if test="type == 2 or type == 0">
			UNION
			SELECT
			tu.`id`,tus.`name`,tu.`phone`,tus.`cardID`,'2' as
			type,tus.`debit_card`,tus.`debit_card_bank`,tus.`credit_card`,tus.`credit_card_bank`,(SELECT
			SUM(tou.amount) FROM t_orders tou WHERE
			tou.`user_id`=tur.`user_id`
			and tou.status=200
			<if test="startTime != null">
				and tou.create_date &gt;=#{startTime}
			</if>
			<if test="endTime != null">
				and tou.create_date &lt;=#{endTime}
			</if>
			) AS sumSellAmount,SUM(toc.commission) as
			sumCommission,tu.create_date
			FROM t_users tu
			LEFT JOIN t_users_sales
			tus ON tu.id=tus.`user_id`
			LEFT JOIN t_orders_commission toc
			ON tu.id =
			toc.`beneficiary_id`
			LEFT JOIN
			t_users_recommender tur ON
			tu.id=tur.`user_id`
			WHERE
			tur.`grandpa_id`=
			#{uId}
			<if test="startTime != null">
				and toc.create_date &gt;=#{startTime}
			</if>
			<if test="endTime != null">
				and toc.create_date &lt;=#{endTime}
			</if>
			GROUP BY tu.`id`
		</if>
		) AS tmp ORDER BY create_date DESC
		LIMIT
		#{pageStartNumber},#{pageEndNumber}
	</select>

	<select id="selectCountRecommenderByUid" resultType="java.lang.Integer">
		select count(*) from
		(
		SELECT
		tus.`name`,tus.`cardID`,'0' as
		type,tus.`debit_card`,tus.`debit_card_bank`,tus.`credit_card`,tus.`credit_card_bank`,(SELECT
		SUM(tou.amount) FROM t_orders tou WHERE
		tou.`user_id`=tu.`id` and
		tou.status=200
		<if test="startTime != null">
			and tou.create_date &gt;=#{startTime}
		</if>
		<if test="endTime != null">
			and tou.create_date &lt;=#{endTime}
		</if>
		) AS sumSellAmount,SUM(toc.commission) as
		sumCommission,tu.create_date
		FROM t_users tu
		LEFT JOIN t_users_sales tus
		ON tu.id=tus.`user_id`
		LEFT
		JOIN t_orders_commission toc
		ON tu.id =
		toc.`beneficiary_id`
		LEFT JOIN
		t_users_recommender tur ON
		tu.id=tur.`user_id`
		WHERE tu.`id` =
		#{uId}
		<if test="startTime != null">
			and toc.create_date &gt;=#{startTime}
		</if>
		<if test="endTime != null">
			and toc.create_date &lt;=#{endTime}
		</if>
		GROUP BY tu.`id`
		<if test="fatherId != null and (type == 3 or type == 0)">
			UNION
			SELECT
			tus.`name`,tus.`cardID`,'3' as
			type,tus.`debit_card`,tus.`debit_card_bank`,tus.`credit_card`,tus.`credit_card_bank`,(SELECT
			SUM(tou.amount) FROM t_orders tou WHERE
			tou.`user_id`=tu.`id` and
			tou.status=200
			<if test="startTime != null">
				and tou.create_date &gt;=#{startTime}
			</if>
			<if test="endTime != null">
				and tou.create_date &lt;=#{endTime}
			</if>
			) AS sumSellAmount,SUM(toc.commission) as
			sumCommission,tu.create_date
			FROM t_users tu
			LEFT JOIN t_users_sales
			tus ON tu.id=tus.`user_id`
			LEFT JOIN t_orders_commission toc
			ON tu.id =
			toc.`beneficiary_id`
			LEFT JOIN
			t_users_recommender tur ON
			tu.id=tur.`user_id`
			WHERE tu.`id` =
			#{fatherId}
			<if test="startTime != null">
				and toc.create_date &gt;=#{startTime}
			</if>
			<if test="endTime != null">
				and toc.create_date &lt;=#{endTime}
			</if>
			GROUP BY tu.`id`
		</if>
		<if test="grandpaId != null and (type == 4 or type == 0)">
			UNION
			SELECT
			tus.`name`,tus.`cardID`,'4' as
			type,tus.`debit_card`,tus.`debit_card_bank`,tus.`credit_card`,tus.`credit_card_bank`,(SELECT
			SUM(tou.amount) FROM t_orders tou WHERE
			tou.`user_id`=tu.`id` and
			tou.status=200
			<if test="startTime != null">
				and tou.create_date &gt;=#{startTime}
			</if>
			<if test="endTime != null">
				and tou.create_date &lt;=#{endTime}
			</if>
			) AS sumSellAmount,SUM(toc.commission) as
			sumCommission,tu.create_date
			FROM t_users tu
			LEFT JOIN t_users_sales
			tus ON tu.id=tus.`user_id`
			LEFT JOIN t_orders_commission toc
			ON tu.id =
			toc.`beneficiary_id`
			LEFT JOIN
			t_users_recommender tur ON
			tu.id=tur.`user_id`
			WHERE tu.`id` =
			#{grandpaId}
			<if test="startTime != null">
				and toc.create_date &gt;=#{startTime}
			</if>
			<if test="endTime != null">
				and toc.create_date &lt;=#{endTime}
			</if>
			GROUP BY tu.`id`
		</if>
		<if test="type == 1 or type == 0">
			UNION
			SELECT
			tus.`name`,tus.`cardID`,'1' as
			type,tus.`debit_card`,tus.`debit_card_bank`,tus.`credit_card`,tus.`credit_card_bank`,(SELECT
			SUM(tou.amount) FROM t_orders tou WHERE
			tou.`user_id`=tur.`user_id`
			and tou.status=200
			<if test="startTime != null">
				and tou.create_date &gt;=#{startTime}
			</if>
			<if test="endTime != null">
				and tou.create_date &lt;=#{endTime}
			</if>
			) AS sumSellAmount,SUM(toc.commission) as
			sumCommission,tu.create_date
			FROM t_users tu
			LEFT JOIN t_users_sales
			tus ON tu.id=tus.`user_id`
			LEFT JOIN t_orders_commission toc
			ON tu.id =
			toc.`beneficiary_id`
			LEFT JOIN
			t_users_recommender tur ON
			tu.id=tur.`user_id`
			WHERE
			tur.`father_id`=
			#{uId}
			<if test="startTime != null">
				and toc.create_date &gt;=#{startTime}
			</if>
			<if test="endTime != null">
				and toc.create_date &lt;=#{endTime}
			</if>
			GROUP BY tu.`id`
		</if>
		<if test="type == 2 or type == 0">
			UNION
			SELECT
			tus.`name`,tus.`cardID`,'2' as
			type,tus.`debit_card`,tus.`debit_card_bank`,tus.`credit_card`,tus.`credit_card_bank`,(SELECT
			SUM(tou.amount) FROM t_orders tou WHERE
			tou.`user_id`=tur.`user_id`
			and tou.status=200
			<if test="startTime != null">
				and tou.create_date &gt;=#{startTime}
			</if>
			<if test="endTime != null">
				and tou.create_date &lt;=#{endTime}
			</if>
			) AS sumSellAmount,SUM(toc.commission) as
			sumCommission,tu.create_date
			FROM t_users tu
			LEFT JOIN t_users_sales
			tus ON tu.id=tus.`user_id`
			LEFT JOIN t_orders_commission toc
			ON tu.id =
			toc.`beneficiary_id`
			LEFT JOIN
			t_users_recommender tur ON
			tu.id=tur.`user_id`
			WHERE
			tur.`grandpa_id`=
			#{uId}
			<if test="startTime != null">
				and toc.create_date &gt;=#{startTime}
			</if>
			<if test="endTime != null">
				and toc.create_date &lt;=#{endTime}
			</if>
			GROUP BY tu.`id`
		</if>
		) AS tmp
	</select>

	<select id="getRecommenderByUid" resultMap="BaseResultMap">
		SELECT *
		FROM
		t_users_recommender
		where user_id = #{uId}
	</select>

</mapper>